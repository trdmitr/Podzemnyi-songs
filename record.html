<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Record</title>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
    input, select, button { padding: 10px; font-size: 1rem; margin: 6px 0; width: 100%; }
    button { background: #1a56db; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #6b7280; }
    .hidden { display: none; }
    #status { margin-top: 16px; padding: 10px; border-radius: 4px; }
    .success { background: #dcfce7; color: #166534; }
    .error { background: #fee2e2; color: #b91c1c; }
  </style>
</head>
<body>
  <h1>üé∏ Record</h1>

  <div>
    <label><strong>–ü–∞—Ä–æ–ª—å:</strong></label>
    <input type="password" id="pwd" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
  </div>

  <div id="form" class="hidden">
    <label><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong></label>
    <select id="performer">
      <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
    </select>
    <button type="button" onclick="toggleNew()">‚ûï –ù–æ–≤—ã–π</button>

    <div id="new-performer-div" class="hidden">
      <label><strong>–ù–æ–≤—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong></label>
      <input type="text" id="new-performer" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∏–∫—Ç–æ—Ä –¶–æ–π">
    </div>

    <label><strong>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏:</strong></label>
    <input type="text" id="song" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 18 –ë–µ—Ä—ë–∑">

    <button type="button" onclick="save()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Å–Ω—é</button>
  </div>

  <div id="status"></div>

  <button type="button" onclick="window.open('../index.html', '_blank')" class="secondary" style="width:100%;margin-top:24px;">
    üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  </button>

  <script>
    // üîë URL —Ç–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ Render (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π!)
    const API_URL = "https://podzemnyi-auth.onrender.com/api/unlock";

    let currentData = [];

    function load() {
      fetch('data.json')
        .then(r => r.json())
        .then(data => {
          currentData = Array.isArray(data) ? data : [];
          renderPerformerSelect();
        })
        .catch(() => currentData = []);
    }

    function renderPerformerSelect() {
      const sel = document.getElementById('performer');
      sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      currentData.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.name;
        opt.textContent = g.name;
        sel.appendChild(opt);
      });
    }

    function toggleNew() {
      document.getElementById('new-performer-div').classList.toggle('hidden');
    }

    function save() {
      const sel = document.getElementById('performer');
      const newPerformer = document.getElementById('new-performer').value.trim();
      const song = document.getElementById('song').value.trim();

      if (!song) return showStatus('‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏', 'error');
      let performer = sel.value || newPerformer;
      if (!performer) return showStatus('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è', 'error');

      let group = currentData.find(g => g.name === performer);
      if (!group) {
        group = { name: performer, songs: [], image: "" };
        currentData.push(group);
      }
      if (!group.songs.includes(song)) {
        group.songs.push(song);
      }

      const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'data.json';
      a.click();
      URL.revokeObjectURL(a.href);

      showStatus(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${song} ‚Üí ${performer}`, 'success');
      document.getElementById('song').value = '';
      document.getElementById('new-performer').value = '';
    }

    function showStatus(text, cls) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = cls;
      setTimeout(() => el.textContent = '', 5000);
    }

    // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Render
    document.getElementById('pwd').addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        const pwd = document.getElementById('pwd').value;
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pwd })
        });
        if (res.ok) {
          document.getElementById('form').classList.remove('hidden');
          load();
        } else {
          showStatus('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
        }
      }
    });
  </script>
</body>
</html>