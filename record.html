<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Record</title>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
    input, select, button { padding: 10px; font-size: 1rem; margin: 6px 0; width: 100%; }
    button { background: #1a56db; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #6b7280; }
    .hidden { display: none; }
    #status { margin-top: 16px; padding: 10px; border-radius: 4px; }
    .success { background: #dcfce7; color: #166534; }
    .error { background: #fee2e2; color: #b91c1c; }
  </style>
</head>
<body>
  <h1>üé∏ Record</h1>

  <div id="login" style="text-align:center;">
    <label><strong>–ü–∞—Ä–æ–ª—å:</strong></label><br>
    <input type="password" id="pwd" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="width:80%;margin:0 auto;">
    <br><br>
    <button type="button" onclick="login()" style="width:80%;margin:0 auto;">üîê –í–æ–π—Ç–∏</button>
  </div>

  <div id="form" class="hidden">
    <label><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong></label>
    <select id="performer">
      <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
    </select>
    <button type="button" onclick="toggleNew()">‚ûï –ù–æ–≤—ã–π</button>

    <div id="new-performer-div" class="hidden">
      <label><strong>–ù–æ–≤—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong></label>
      <input type="text" id="new-performer" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∏–∫—Ç–æ—Ä –¶–æ–π">
    </div>

    <label><strong>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏:</strong></label>
    <input type="text" id="song" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 18 –ë–µ—Ä—ë–∑">

    <button type="button" onclick="save()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Å–Ω—é</button>
  </div>

  <div id="status"></div>

  <button type="button" onclick="window.open('../index.html', '_blank')" class="secondary" style="width:100%;margin-top:24px;">
    üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  </button>

  <script>
    // üîë –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω ‚Äî –±–µ—Ä—ë—Ç—Å—è –∏–∑ Render —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ (—Å–º. –Ω–∏–∂–µ)
  const GITHUB_TOKEN = 'RENDER_PROVIDES_THIS'; // ‚Üê –Ω–µ –º–µ–Ω—è–π, –∑–∞–º–µ–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    // üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è ‚Äî –Ω–∞ Render
    const AUTH_URL = "https://podzemnyi-auth.onrender.com/api/unlock";
    // üîë –ó–∞–ø–∏—Å—å ‚Äî –≤ GitHub
   
    const OWNER = "trdmitr";
    const REPO = "Podzemnyi-songs";
    const PATH = "data.json";

    let currentData = [];
    let currentSha = "";

    async function login() {
      const pwd = document.getElementById('pwd').value;
      // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å –Ω–∞ Render
      const authRes = await fetch(AUTH_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pwd })
      });
      if (!authRes.ok) {
        return showStatus('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
      }

      // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º data.json –∏–∑ GitHub
      const dataRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`, {
        headers: { Authorization: `Bearer ${GITHUB_TOKEN}` }
      });
      const data = await dataRes.json();
      currentSha = data.sha;
      currentData = JSON.parse(atob(data.content));

      // 3. –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
      document.getElementById('login').style.display = 'none';
      document.getElementById('form').classList.remove('hidden');
      renderPerformerSelect();
    }

    function renderPerformerSelect() {
      const sel = document.getElementById('performer');
      sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      currentData.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.name;
        opt.textContent = g.name;
        sel.appendChild(opt);
      });
    }

    function toggleNew() {
      document.getElementById('new-performer-div').classList.toggle('hidden');
    }

async function save() {
  const sel = document.getElementById('performer');
  const newPerformer = document.getElementById('new-performer').value.trim();
  const song = document.getElementById('song').value.trim();

  if (!song) return showStatus('‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏', 'error');
  let performer = sel.value || newPerformer;
  if (!performer) return showStatus('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è', 'error');

  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
  let group = currentData.find(g => g.name === performer);
  if (!group) {
    group = { name: performer, songs: [], image: "" };
    currentData.push(group);
  }
  if (!group.songs.includes(song)) group.songs.push(song);

  // üî• –ó–∞–ø–∏—Å—å –≤ GitHub
  try {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π SHA –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ data.json
    const getRes = await fetch('https://api.github.com/repos/trdmitr/Podzemnyi-songs/contents/data.json', {
      headers: { 'Authorization': `Bearer ${GITHUB_TOKEN}` }
    });
    const { sha } = await getRes.json();

    // –ö–æ–¥–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    const content = btoa(JSON.stringify(currentData, null, 2));

    // –û–±–Ω–æ–≤–ª—è–µ–º
    const putRes = await fetch('https://api.github.com/repos/trdmitr/Podzemnyi-songs/contents/data.json', {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `+ ${song} ‚Üí ${performer}`,
        content,
        sha
      })
    });

    if (putRes.ok) {
      showStatus(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${song} ‚Üí ${performer}`, 'success');
      document.getElementById('song').value = '';
      document.getElementById('new-performer').value = '';
    } else {
      const err = await putRes.text();
      showStatus(`‚ùå –û—à–∏–±–∫–∞: ${err}`, 'error');
    }
  } catch (e) {
    showStatus(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`, 'error');
  }
}

    function showStatus(text, cls) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = cls;
      setTimeout(() => el.textContent = '', 5000);
    }
  </script>
</body>
</html>